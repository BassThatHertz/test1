FROM ubuntu:bionic


COPY . /usr/src/sdk
RUN ls /usr/src/sdk/autoconf.bash
WORKDIR /usr/src/sdk
RUN mkdir /opt/intel
RUN mkdir /opt/intel/sgxsdk
RUN mkdir /opt/intel/sgxsdk/include

COPY docker/install-psw-lunix-sgx.patch ./
COPY docker/install-psw-dcap-source.patch ./

RUN    apt update && \
       apt install -yq apt-utils && \
       apt install -yq --no-install-recommends python-yaml vim unzip \
           telnet git ca-certificates build-essential lsb-release ocaml ocamlbuild \
           automake autoconf libtool wget python libssl-dev cmake perl \
           libcurl4-openssl-dev protobuf-compiler git libprotobuf-dev debhelper reprepro \
           libboost-all-dev alien debhelper uuid-dev libxml2-dev ccache libprotobuf10 \
           yasm flex bison libprocps-dev ccache autoconf texinfo \
           libjsonrpccpp-dev curl libjsonrpccpp-tools && \
       ln -s /usr/bin/ccache /usr/local/bin/clang && \
       ln -s /usr/bin/ccache /usr/local/bin/clang++ && \
       ln -s /usr/bin/ccache /usr/local/bin/gcc && \
       ln -s /usr/bin/ccache /usr/local/bin/g++ && \
       ln -s /usr/bin/ccache /usr/local/bin/cc && \
       ln -s /usr/bin/ccache /usr/local/bin/c++

RUN    git clone -b sgx_2.13 --depth 1 https://github.com/intel/linux-sgx && \
       cd linux-sgx && \
       patch -p1 -i ../install-psw-linux-sgx.patch && \
       make preparation && \
       cd external/dcap_source && patch -p1 -i ../../../install-psw-dcap-source.patch && \
       cd ../../ && cp external/toolset/ubuntu18.04/* /usr/local/bin && \
       which as ld ld.gold objdump

RUN    cd linux-sgx && make -s -j$(nproc) sdk_install_pkg && \
       ./linux/installer/bin/sgx_linux_x64_sdk_2.13.100.4.bin --prefix=/opt/intel && \
       /bin/bash -c "source /opt/intel/sgxsdk/environment" && make -s -j$(nproc) deb_psw_pkg && \
       ./linux/installer/bin/sgx_linux_x64_psw_2.13.100.4.bin && cd .. && rm -rf linux-sgx/

RUN    cd scripts && ./build_deps.py && \
       wget --progress=dot:mega -O - https://github.com/intel/dynamic-application-loader-host-interface/archive/072d233296c15d0dcd1fb4570694d0244729f87b.tar.gz | tar -xz && \
       cd dynamic-application-loader-host-interface-072d233296c15d0dcd1fb4570694d0244729f87b && \
       cmake . -DCMAKE_BUILD_TYPE=Release -DINIT_SYSTEM=SysVinit && \
       make install && \
       cd .. && rm -rf dynamic-application-loader-host-interface-072d233296c15d0dcd1fb4570694d0244729f87b && \
       cd /usr/src/sdk && \
       ./autoconf.bash && \
       ./configure  && \
       bash -c "make -j$(nproc)"
